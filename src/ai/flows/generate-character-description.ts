'use server';
/**
 * @fileOverview An AI agent that generates a detailed character description and infers key attributes (class, traits, knowledge, background) from free text input.
 *
 * - generateCharacterDescription - A function that generates a character description and infers attributes.
 * - GenerateCharacterDescriptionInput - The input type for the generateCharacterDescription function.
 * - GenerateCharacterDescriptionOutput - The return type for the generateCharacterDescription function.
 */

import {ai} from '@/ai/ai-instance';
import {z} from 'genkit';

// Define standard classes for better inference consistency
const CharacterClasses = z.enum([
    "Warrior", "Mage", "Rogue", "Scholar", "Hunter", "Healer", "Bard", "Artisan", "Noble", "Commoner", "Adventurer" // Added Adventurer as a fallback
]).default("Adventurer"); // Default if cannot infer

const GenerateCharacterDescriptionInputSchema = z.object({
  characterDescription: z
    .string()
    .describe("A free-text description of the character's appearance, personality, and backstory."),
});
export type GenerateCharacterDescriptionInput = z.infer<typeof GenerateCharacterDescriptionInputSchema>;

const GenerateCharacterDescriptionOutputSchema = z.object({
  detailedDescription: z
    .string()
    .describe('A detailed character profile generated by the AI, elaborating on the input.'),
  inferredClass: CharacterClasses.describe("The character class inferred from the description (e.g., Warrior, Mage, Rogue). Default to 'Adventurer' if unclear."),
  inferredTraits: z.array(z.string()).max(5).describe("A list of up to 5 key personality traits inferred from the description (e.g., Brave, Curious, Stern)."),
  inferredKnowledge: z.array(z.string()).max(5).describe("A list of up to 5 distinct areas of knowledge or skills inferred (e.g., Herbalism, Swordplay, Ancient History)."),
  inferredBackground: z.string().max(100).describe("A brief background summary inferred from the description (e.g., Exiled Noble, Village Blacksmith, Mysterious Wanderer)."),
});
export type GenerateCharacterDescriptionOutput = z.infer<typeof GenerateCharacterDescriptionOutputSchema>;

export async function generateCharacterDescription(
  input: GenerateCharacterDescriptionInput
): Promise<GenerateCharacterDescriptionOutput> {
  return generateCharacterDescriptionFlow(input);
}

const prompt = ai.definePrompt({
  name: 'generateCharacterDescriptionPrompt',
  input: { schema: GenerateCharacterDescriptionInputSchema },
  output: { schema: GenerateCharacterDescriptionOutputSchema },
  prompt: `You are a fantasy story writer and character profiler. Based on the provided character description:

1.  **Elaborate:** Write a detailed character profile that expands on the user's description, capturing appearance, personality, and potential backstory hints. Store this in 'detailedDescription'.
2.  **Infer Class:** Determine the most fitting character class from the list [Warrior, Mage, Rogue, Scholar, Hunter, Healer, Bard, Artisan, Noble, Commoner, Adventurer]. Prioritize specific classes if strongly suggested, otherwise default to 'Adventurer'. Store this in 'inferredClass'.
3.  **Infer Traits:** Identify and list up to 5 distinct personality traits evident in the description. Store these as an array of strings in 'inferredTraits'.
4.  **Infer Knowledge/Skills:** Identify and list up to 5 distinct areas of knowledge or key skills mentioned or strongly implied. Store these as an array of strings in 'inferredKnowledge'.
5.  **Infer Background:** Summarize the character's likely background or origin story in a brief phrase (max 100 characters). Store this in 'inferredBackground'.

**User's Character Description:**
{{{characterDescription}}}

**Output Format:** Respond ONLY with the JSON object matching the GenerateCharacterDescriptionOutput schema. Ensure all fields (detailedDescription, inferredClass, inferredTraits, inferredKnowledge, inferredBackground) are populated correctly based on your inferences.
`,
});


const generateCharacterDescriptionFlow = ai.defineFlow<
  typeof GenerateCharacterDescriptionInputSchema,
  typeof GenerateCharacterDescriptionOutputSchema
>(
  {
    name: 'generateCharacterDescriptionFlow',
    inputSchema: GenerateCharacterDescriptionInputSchema,
    outputSchema: GenerateCharacterDescriptionOutputSchema,
  },
  async (input) => {
    console.log("Sending to generateCharacterDescriptionPrompt:", JSON.stringify(input, null, 2));
    const { output } = await prompt(input);

    if (!output || !output.detailedDescription) {
        console.error("AI description generation failed to return a valid output.", output);
        // Provide a fallback response indicating failure but still attempting to populate basic fields if possible
         return {
            detailedDescription: `AI generation failed. Could not elaborate on: "${input.characterDescription.substring(0, 100)}..."`,
            inferredClass: "Adventurer", // Default fallback
            inferredTraits: [],
            inferredKnowledge: [],
            inferredBackground: "Unknown",
        };
    }
    // Ensure arrays are arrays even if AI messes up (though schema should handle this)
    output.inferredTraits = Array.isArray(output.inferredTraits) ? output.inferredTraits : [];
    output.inferredKnowledge = Array.isArray(output.inferredKnowledge) ? output.inferredKnowledge : [];
    // Ensure class is valid or default
    output.inferredClass = CharacterClasses.parse(output.inferredClass); // Use Zod enum parser with default

    console.log("Received from generateCharacterDescriptionPrompt:", JSON.stringify(output, null, 2));
    return output; // Return the full output including inferred fields
  }
);
